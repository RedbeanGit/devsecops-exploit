import http from "http";
import { exec } from "child_process";

const port = 3000;

// Create an HTTP server
const server = http.createServer((req, res) => {
  if (req.url === "/command" && req.method === "POST") {
    // Collect data from the POST request
    let body = "";
    req.on("data", (chunk) => {
      body += chunk.toString(); // Convert Buffer to string
    });
    req.on("end", () => {
      try {
        const data = JSON.parse(body); // Parse the JSON data
        if (data.cmd) {
          // Execute the command
          exec(data.cmd, (error, stdout, stderr) => {
            if (error) {
              res.writeHead(500);
              res.end(`Error: ${error.message}`);
              return;
            }
            if (stderr) {
              res.writeHead(200);
              res.end(`STDERR: ${stderr}`);
              return;
            }
            res.writeHead(200);
            res.end(stdout);
          });
        } else {
          res.writeHead(400);
          res.end("Please provide a command to execute in JSON format.");
        }
      } catch (e) {
        res.writeHead(400);
        res.end("Invalid JSON");
      }
    });
  } else {
    // Respond with 404 for other routes
    res.writeHead(404);
    res.end("Not found");
  }
});

// Start the server
server.listen(port, () => {
  console.log(`Server started on http://localhost:${port}`);
});
